{% from "personal/map.jinja" import account %}
{% from "salt/minion/config/map.jinja" import config as salt_config %}

{% set _pyenv_pillar = salt.pillar.get('python:pyenv', {}) %}


{# VALIDATIONS #}
{% if _pyenv_pillar.python_versions is not defined %}
  {% do _pyenv_pillar.update({ 'python_versions': [] }) %}
{% endif %}


{# PYENV #}
{% set _pyenv_by_kernel = salt['grains.filter_by']({

  'default': { },

  'Darwin': {
    'path': {
      'brew_version': '/usr/local/Cellar/pyenv/' + _pyenv_pillar.version,
    }
  },

  'Linux': {
    'git_rev': 'v' + _pyenv_pillar.version,
  },

}, grain='kernel') %}


{# EXTRA #}
{% set _pyenv_root = account.info.home + "/.pyenv" %}

{% set _additional_data = {
  'path': {
    'root': _pyenv_root,
    'bin': _pyenv_root + "/bin",
    'plugins': _pyenv_root + "/plugins",
  },
  'user': account.username,

  'minion_conf_file': salt_config.directory + '/pyenv.conf'
} %}

{# EXPOSE #}
{% set pyenv = salt.slsutil.merge_all([_pyenv_pillar, _pyenv_by_kernel, _additional_data]) %}
{% do pyenv.update({ 'supported_kernel': salt.grains.get('os') == "Ubuntu" or salt.grains.get('kernel') == "Darwin" }) %}
